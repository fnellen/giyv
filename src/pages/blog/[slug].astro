---
import fetchApi from "../../lib/strapi";
import qs from "qs";
import type Article from "../../interfaces/article";
import { createGetStaticPaths } from "astro-i18n";
import { marked } from "marked";
import PostLayout from "../../layouts/PostLayout.astro";
import { remark } from "remark";
import remarkToc from "remark-toc";
import { rehype } from "rehype";
import rehypeAutolinkHeadings from "rehype-autolink-headings";
import rehypeSlug from "rehype-slug";

export async function rehypetoc(
  article: Article,
  locale: string,
): Promise<string> {
  const heading =
    {
      de: "Inhalte",
      it: "Contenuti",
      default: "Contents",
    }[locale] || "Contents";
  const toc = await remark()
    .use(remarkToc, {
      tight: true,
      maxDepth: 3,
      heading: heading,
    })
    .process(article.attributes.content);

  const rehypedContent = await rehype()
    .data("settings", { fragment: true })
    .use(rehypeSlug)
    .use(rehypeAutolinkHeadings)
    .process(marked.parse(toc.toString()));

  return rehypedContent.toString();
}

export function getStaticPathsWithI18n(locale: string) {
  return createGetStaticPaths(async ({}) => {
    const query = qs.stringify({
      populate: {
        featuredImage: {
          fields: ["name", "width", "height", "url", "alternativeText"],
        },
        instagramPost: {
          populate: {
            images: {
              fields: ["url", "name", "width", "height", "alternativeText"],
            },
          },
        },
        category: {
          populate: {
            fields: ["Name"],
          },
        },
        seo: {
          populate: "*",
        },
        localizations: {
          populate: "*",
        },
        group: {
          populate: {
            authors: {
              populate: {
                bioImage: {
                  fields: ["url", "name", "width", "height", "alternativeText"],
                },
                socials: {
                  populate:"*"
                },
              },
            },
          },
        },
      },
    });
    const data = await fetchApi<Article[]>({
      endpoint: `articles?locale=${locale}&`,
      wrappedByKey: "data",
      query: query,
    });

    const posts = await Promise.all(
      data.map(async (post) => {
        post.attributes.content = await rehypetoc(post, locale);
        return post;
      }),
    );

    const mappedPosts = posts.map((post) => ({
      params: { slug: post.attributes.slug },
      props: { post, content_rehyped: post.attributes.content },
    }));

    return mappedPosts;
  });
}

export const getStaticPaths = getStaticPathsWithI18n("de");
type Props = {
  post: Article;
  content_rehyped: string;
};
const { post, content_rehyped } = Astro.props;
---

<PostLayout {...post}>
  <div
    class="prose md:prose-lg lg:prose-xl prose-a:text-blue-600 mb-16 dark:prose-invert prose-img:w-auto prose-img:rounded-xl prose-img:mx-auto"
    set:html={content_rehyped}
  />
</PostLayout>
